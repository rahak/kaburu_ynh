#!/bin/bash
set -e

#=================================================
# COMMON VARIABLES & HELPERS
#=================================================
source /usr/share/yunohost/helpers

app=$YNH_APP_INSTANCE_NAME
install_dir="/opt/$app"

email="${local_part}@${domain}"

#=================================================
# CHECKS
#=================================================
ynh_print_info "Installing Kaburu (email â†’ webhook forwarder)"

# Ensure required arguments exist
if [[ -z "$domain" || -z "$local_part" || -z "$imap_password" || -z "$webhook_url" ]]; then
  ynh_die "Missing required install parameters"
fi

#=================================================
# DEPENDENCIES
#=================================================
ynh_print_info "Installing dependencies"
ynh_install_app_dependencies python3-requests jq

#=================================================
# SYSTEM USER
#=================================================
ynh_print_info "Creating system user"
ynh_system_user_create --username="$app" --home_dir="$install_dir"


#=================================================
# SAVE SETTINGS
#=================================================
ynh_print_info "Saving app settings"

ynh_app_setting_set "$app" domain "$domain"
ynh_app_setting_set "$app" local_part "$local_part"
ynh_app_setting_set "$app" webhook_url "$webhook_url"
ynh_app_setting_set "$app" api_secret "$api_secret"
ynh_app_setting_set "$app" parse_attachments "$parse_attachments"
ynh_app_setting_set "$app" imap_password "$imap_password"

#=================================================
# INSTALL FILES
#=================================================
ynh_print_info "Installing application files"

mkdir -p "$install_dir"/{data,logs}

cp ../conf/parse_mail.py "$install_dir/parse_mail.py"
chmod 750 "$install_dir/parse_mail.py"

#=================================================
# CONFIG FILE
#=================================================
ynh_print_info "Creating config.json"

cat > "$install_dir/config.json" <<EOF
{
  "domain": "$domain",
  "local_part": "$local_part",
  "webhook_url": "$webhook_url",
  "api_secret": "$api_secret",
  "parse_attachments": $([ "$parse_attachments" = "true" ] || [ "$parse_attachments" = "1" ] && echo "true" || echo "false"),
  "imap_password": "$imap_password"
}
EOF

chmod 600 "$install_dir/config.json"

#=================================================
# STATE FILES
#=================================================
echo "[]" > "$install_dir/processed_uids.json"
chmod 600 "$install_dir/processed_uids.json"

#=================================================
# OWNERSHIP
#=================================================
chown -R "$app:$app" "$install_dir"

#=================================================
# CRON JOB
#=================================================
ynh_print_info "Setting up cron job"

cat > "/etc/cron.d/$app" <<EOF
# Kaburu: Poll IMAP mailbox and forward to webhook
* * * * * $app cd $install_dir && ./parse_mail.py >> $install_dir/logs/cron.log 2>&1
EOF

chmod 644 "/etc/cron.d/$app"

#=================================================
# FINAL MESSAGE
#=================================================
ynh_print_info "âœ… Kaburu installed successfully"
ynh_print_info ""
ynh_print_info "ğŸ“§ Listening mailbox: $email"
ynh_print_info "ğŸ” IMAP password: (stored securely)"
ynh_print_info "ğŸ”— Webhook: $webhook_url"
ynh_print_info "ğŸ“Š Logs: $install_dir/logs/cron.log"
ynh_print_info ""
ynh_print_info "âš  IMPORTANT:"
ynh_print_info "â€¢ The mailbox $email MUST already exist"
ynh_print_info "â€¢ IMAP must be enabled for that user"
ynh_print_info ""
ynh_print_info "Test:"
ynh_print_info "  echo 'Test' | mail -s 'Test' $email"

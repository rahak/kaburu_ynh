#!/bin/bash
set -e

# Load YunoHost helper
source /usr/share/yunohost/helpers

app=$YNH_APP_INSTANCE_NAME

# --- Validation ---

# Construct full email
email="${local_part}@${domain}"

# Generate random password for the mailbox
imap_password=$(ynh_string_random --length=32)

# Validate webhook reachability
webhook_check_url="$webhook_url"
if [[ "$webhook_url" =~ ^/ ]]; then
    webhook_check_url="http://127.0.0.1$webhook_url"
fi

ynh_print_info "Validating webhook reachability..."
if ! curl -s -o /dev/null --max-time 5 "$webhook_check_url"; then
    ynh_print_warn "Could not reach webhook at $webhook_check_url. Please verify the URL."
fi

# --- Dependencies ---
ynh_install_app_dependencies python3-requests

# --- Install ---

ynh_system_user_create --username=$app --home_dir="/opt/$app"

ynh_app_setting_set $app domain "$domain"
ynh_app_setting_set $app local_part "$local_part"
ynh_app_setting_set $app webhook_url "$webhook_url"
ynh_app_setting_set $app api_secret "$api_secret"
ynh_app_setting_set $app parse_attachments "$parse_attachments"
ynh_app_setting_set $app imap_password "$imap_password"

# Create YunoHost user for email receiving (or update password if exists)
ynh_print_info "Setting up email user..."
if yunohost user list --output-as json | jq -e ".users.\"$local_part\"" >/dev/null 2>&1; then
    ynh_print_warn "User $local_part already exists. Updating password for Kaburu to use."
    yunohost user update "$local_part" --change-password "$imap_password"
else
    yunohost user create "$local_part" -f Kaburu -l Webhook -m "$email" -d "$domain" -p "$imap_password"
fi

install_dir="/opt/$app"
mkdir -p "$install_dir"/{data,logs}

# Copy parse_mail.py from packaging directory
cp "../conf/parse_mail.py" "$install_dir/parse_mail.py"
chmod +x "$install_dir/parse_mail.py"

# Generate config.json for the python script
cat > "$install_dir/config.json" <<JSON
{
  "domain": "$domain",
  "local_part": "$local_part",
  "webhook_url": "$webhook_url",
  "api_secret": "$api_secret",
  "parse_attachments": $parse_attachments,
  "imap_password": "$imap_password"
}
JSON
chmod 600 "$install_dir/config.json"

chown -R $app:$app "$install_dir"

# --- Cron Job Setup ---
ynh_print_info "Setting up cron job to check emails..."

# Create cron job to check emails every minute
cat > "/etc/cron.d/${app}" <<CRON
# Check for new emails and forward to webhook
* * * * * $app $install_dir/parse_mail.py >> $install_dir/logs/cron.log 2>&1
CRON

ynh_print_info "Installation complete! Email: $email -> Webhook: $webhook_url"
ynh_print_info "Emails will be checked every minute and forwarded to your webhook."

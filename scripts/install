#!/bin/bash
set -e

source /usr/share/yunohost/helpers

app=$YNH_APP_INSTANCE_NAME
email="${local_part}@${domain}"
imap_password=$(ynh_string_random --length=32)

ynh_print_info "Installing Kaburu emailâ†’webhook forwarder..."

# Install dependencies
ynh_install_app_dependencies python3-requests

# Create system user for the app
ynh_system_user_create --username=$app --home_dir="/opt/$app"

# Save settings
ynh_app_setting_set $app domain "$domain"
ynh_app_setting_set $app local_part "$local_part"
ynh_app_setting_set $app webhook_url "$webhook_url"
ynh_app_setting_set $app api_secret "$api_secret"
ynh_app_setting_set $app parse_attachments "$parse_attachments"
ynh_app_setting_set $app imap_password "$imap_password"

# Create YunoHost mailbox user (the key to everything!)
ynh_print_info "Creating mailbox user: $email"

if yunohost user list --output-as json | jq -e ".users.\"$local_part\"" >/dev/null 2>&1; then
  ynh_print_info "User $local_part already exists, updating password..."
  yunohost user update "$local_part" --change-password "$imap_password"
else
  ynh_print_info "Creating new user: $local_part"
  # YunoHost user create syntax: username, then options
  yunohost user create "$local_part" \
    --domain "$domain" \
    --fullname "Kaburu Webhook" \
    --mail "$email" \
    --password "$imap_password" \
    --mailbox-quota 0
fi

# Setup app directory
install_dir="/opt/$app"
mkdir -p "$install_dir"/{data,logs}
cp "../conf/parse_mail.py" "$install_dir/parse_mail.py"
chmod +x "$install_dir/parse_mail.py"

# Create config file with proper boolean value
cat > "$install_dir/config.json" <<JSON
{
  "domain": "$domain",
  "local_part": "$local_part",
  "webhook_url": "$webhook_url",
  "api_secret": "$api_secret",
  "parse_attachments": $([ "$parse_attachments" = "true" ] || [ "$parse_attachments" = "1" ] && echo "true" || echo "false"),
  "imap_password": "$imap_password"
}
JSON

chmod 600 "$install_dir/config.json"
chown -R $app:$app "$install_dir"

# Create empty processed UIDs file
echo "[]" > "$install_dir/processed_uids.json"
chown $app:$app "$install_dir/processed_uids.json"

# Setup cron job to poll IMAP every minute
cat > "/etc/cron.d/${app}" <<CRON
# Kaburu: Poll IMAP mailbox and forward to webhook
* * * * * $app cd $install_dir && ./parse_mail.py >> $install_dir/logs/cron.log 2>&1
CRON

ynh_print_info "âœ… Installation complete!"
ynh_print_info ""
ynh_print_info "ðŸ“§ Mailbox created: $email"
ynh_print_info "ðŸ”— Webhook target: $webhook_url"
ynh_print_info "ðŸ“Š Logs: $install_dir/logs/cron.log"
ynh_print_info ""
ynh_print_info "How it works:"
ynh_print_info "  1. Emails sent to $email are delivered normally by Postfix"
ynh_print_info "  2. Dovecot stores them in the user's mailbox"
ynh_print_info "  3. Kaburu polls via IMAP every minute"
ynh_print_info "  4. Processed emails are forwarded to your webhook"
ynh_print_info "  5. Successfully processed emails are deleted"
#!/bin/bash
set -e

source /usr/share/yunohost/helpers

app=$YNH_APP_INSTANCE_NAME
email="${local_part}@${domain}"
imap_password=$(ynh_string_random --length=32)

# Install dependencies
ynh_install_app_dependencies python3-requests

# Create system user
ynh_system_user_create --username=$app --home_dir="/opt/$app"

# Save settings
ynh_app_setting_set $app domain "$domain"
ynh_app_setting_set $app local_part "$local_part"
ynh_app_setting_set $app webhook_url "$webhook_url"
ynh_app_setting_set $app api_secret "$api_secret"
ynh_app_setting_set $app parse_attachments "$parse_attachments"
ynh_app_setting_set $app imap_password "$imap_password"

# Create YunoHost user for email
if yunohost user list --output-as json | jq -e ".users.\"$local_part\"" >/dev/null 2>&1; then
    echo "$imap_password" | yunohost user update "$local_part" --change-password
else
    echo "$imap_password" | yunohost user create "$local_part" --fullname "Kaburu Webhook" --mail "$email" -p
fi

# Setup app directory
install_dir="/opt/$app"
mkdir -p "$install_dir"/{data,logs}
cp "../conf/parse_mail.py" "$install_dir/parse_mail.py"
chmod +x "$install_dir/parse_mail.py"

# Create config file
cat > "$install_dir/config.json" <<JSON
{
  "domain": "$domain",
  "local_part": "$local_part",
  "webhook_url": "$webhook_url",
  "api_secret": "$api_secret",
  "parse_attachments": $parse_attachments,
  "imap_password": "$imap_password"
}
JSON
chmod 600 "$install_dir/config.json"
chown -R $app:$app "$install_dir"

# Setup cron job (check every minute)
cat > "/etc/cron.d/${app}" <<CRON
* * * * * $app $install_dir/parse_mail.py >> $install_dir/logs/cron.log 2>&1
CRON

ynh_print_info "âœ… Installed! Email: $email -> Webhook: $webhook_url"

#!/bin/bash
set -e

source /usr/share/yunohost/helpers

app=$YNH_APP_INSTANCE_NAME

# Restore app directory
ynh_restore_file --origin_path="/opt/$app"

# Recreate system user
ynh_system_user_create --username=$app --home_dir="/opt/$app"
chown -R $app:$app /opt/$app

# Recreate email user and cron
domain=$(ynh_app_setting_get $app domain)
local_part=$(ynh_app_setting_get $app local_part)
email="${local_part}@${domain}"
install_dir="/opt/$app"
imap_password=$(ynh_app_setting_get $app imap_password)

# Recreate YunoHost user
echo "$imap_password" | yunohost user create "$local_part" --fullname "Kaburu Webhook" --mail "$email" --password || true

# Recreate cron job
cat > "/etc/cron.d/${app}" <<CRON
# Check for new emails and forward to webhook
* * * * * $app $install_dir/parse_mail.py >> $install_dir/logs/cron.log 2>&1
CRON
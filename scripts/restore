#!/bin/bash
set -e

source /usr/share/yunohost/helpers

app=$YNH_APP_INSTANCE_NAME

ynh_print_info "Restoring Kaburu..."

# Restore app directory
ynh_restore_file --origin_path="/opt/$app"

# Recreate system user
ynh_system_user_create --username=$app --home_dir="/opt/$app"
chown -R $app:$app /opt/$app

# Get saved settings
domain=$(ynh_app_setting_get $app domain)
local_part=$(ynh_app_setting_get $app local_part)
email="${local_part}@${domain}"
install_dir="/opt/$app"
imap_password=$(ynh_app_setting_get $app imap_password)

# Recreate YunoHost mailbox user
ynh_print_info "Recreating mailbox: $email"

if ! yunohost user list --output-as json | jq -e ".users.\"$local_part\"" >/dev/null 2>&1; then
  yunohost user create "$local_part" \
    --domain "$domain" \
    --fullname "Kaburu Webhook" \
    --mail "$email" \
    --password "$imap_password" \
    --mailbox-quota 0
fi

# Restore cron job
ynh_restore_file --origin_path="/etc/cron.d/${app}"

ynh_print_info "âœ… Restore complete!"
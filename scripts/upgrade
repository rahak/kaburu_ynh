#!/bin/bash
set -e

source /usr/share/yunohost/helpers

app=$YNH_APP_INSTANCE_NAME
install_dir="/opt/$app"

ynh_print_info "Upgrading $app..."

# Ensure dependencies
ynh_install_app_dependencies python3-requests

# Update parse_mail.py from packaging directory
ynh_print_info "Updating parse_mail.py script..."
cp "../conf/parse_mail.py" "$install_dir/parse_mail.py"
chmod +x "$install_dir/parse_mail.py"
chown $app:$app "$install_dir/parse_mail.py"

# Regenerate config.json from settings
domain=$(ynh_app_setting_get $app domain)
local_part=$(ynh_app_setting_get $app local_part)
webhook_url=$(ynh_app_setting_get $app webhook_url)
api_secret=$(ynh_app_setting_get $app api_secret)
parse_attachments=$(ynh_app_setting_get $app parse_attachments)

cat > "$install_dir/config.json" <<JSON
{
  "domain": "$domain",
  "local_part": "$local_part",
  "webhook_url": "$webhook_url",
  "api_secret": "$api_secret",
  "parse_attachments": $parse_attachments
}
JSON
chmod 600 "$install_dir/config.json"
chown $app:$app "$install_dir/config.json"

# Ensure Postfix master.cf has the pipe entry
ynh_print_info "Checking Postfix configuration..."
if ! grep -q "^${app}-pipe unix" /etc/postfix/master.cf; then
    cat >> /etc/postfix/master.cf <<POSTFIX_EOF

# Kaburu email webhook pipe
${app}-pipe unix - n n - - pipe
  flags=Rq user=$app argv=$install_dir/parse_mail.py
POSTFIX_EOF
    systemctl reload postfix
fi

ynh_print_info "Upgrade complete!"
#!/bin/bash
set -e

source /usr/share/yunohost/helpers

app=$YNH_APP_INSTANCE_NAME
install_dir="/opt/$app"

ynh_print_info "Upgrading Kaburu..."

#=================================================
# UPDATE APPLICATION CODE
#=================================================
ynh_backup_before_upgrade

cp "../conf/parse_mail.py" "$install_dir/parse_mail.py"
chmod 750 "$install_dir/parse_mail.py"
chown "$app:$app" "$install_dir/parse_mail.py"

#=================================================
# REGENERATE CONFIG FILE
#=================================================
domain=$(ynh_app_setting_get "$app" domain)
local_part=$(ynh_app_setting_get "$app" local_part)
webhook_url=$(ynh_app_setting_get "$app" webhook_url)
api_secret=$(ynh_app_setting_get "$app" api_secret)
parse_attachments=$(ynh_app_setting_get "$app" parse_attachments)
imap_password=$(ynh_app_setting_get "$app" imap_password)

# Normalize boolean for JSON
if [ "$parse_attachments" = "1" ] || [ "$parse_attachments" = "true" ]; then
  parse_attachments="true"
else
  parse_attachments="false"
fi

cat > "$install_dir/config.json" <<JSON
{
  "domain": "$domain",
  "local_part": "$local_part",
  "webhook_url": "$webhook_url",
  "api_secret": "$api_secret",
  "parse_attachments": $parse_attachments,
  "imap_password": "$imap_password"
}
JSON

chmod 600 "$install_dir/config.json"
chown "$app:$app" "$install_dir/config.json"

#=================================================
# ENSURE CRON EXISTS (DO NOT OVERWRITE)
#=================================================
if [ ! -f "/etc/cron.d/$app" ]; then
  cat > "/etc/cron.d/$app" <<CRON
# Kaburu: Poll IMAP mailbox and forward to webhook
* * * * * $app cd $install_dir && ./parse_mail.py >> $install_dir/logs/cron.log 2>&1
CRON
fi

ynh_print_info "âœ… Upgrade complete"
